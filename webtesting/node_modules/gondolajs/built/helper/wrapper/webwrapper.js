"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebDriverWrapper=void 0;const constants_1=require("../../constants"),errors=__importStar(require("../../errors")),message_1=require("../../message"),WebDriverHelper_1=require("../utils/WebDriverHelper"),Utils=__importStar(require("../utils/WebUtils"));class WebDriverWrapper{async dragAndDrop(e,t,r){this._instanceOfCoordinate(e)?this._instanceOfCoordinate(t)?await this.dragAndDropMouse(e,t,r):await this.dragAndDropToElement(e,t,r):this._instanceOfCoordinate(t)?await this.dragElementToCoordinate(e,t,r):await this.dragElementToElement(e,t,r)}async getControlProperty(e,t){const r=await Utils.findFirstElement(this.helper,e);return await r.getProperty(t)}async moveMouse(e,t){var r,i,o,a,n,s,l,h,d,c;if(!this.helper)return;const w="safari"===(null===(o=null===(i=null===(r=this.helper.browser)||void 0===r?void 0:r.capabilities)||void 0===i?void 0:i.browserName)||void 0===o?void 0:o.toLowerCase()),p=null===(s=null===(n=null===(a=this.helper.browser)||void 0===a?void 0:a.capabilities)||void 0===n?void 0:n.browserVersion)||void 0===s?void 0:s.startsWith("13.1"),u=null===(d=null===(h=null===(l=this.helper.browser)||void 0===l?void 0:l.capabilities)||void 0===h?void 0:h.browserVersion)||void 0===d?void 0:d.startsWith("13.0");if(e&&this._instanceOfCoordinate(e)){if(w&&p){const t=await this.getElementBounds("//html/body"),r=30;e.y=e.y+t.top+r}return await(null===(c=this.helper)||void 0===c?void 0:c.moveCursorTo("//html/body",e.x,e.y))}let m,y;e=e||"//html/body";const f=await this.getElementBounds(e);return t?(m=t.x,y=t.y):(m=f.width/2,y=f.height/2),w&&(p||u)?(m+=f.left,y+=f.top,await WebDriverHelper_1.moveMouseByJS(this.helper,e,m,y)):await this.helper.moveCursorTo(e,m,y)}async selectByIndex(e,t){if(t<0)throw new errors.NegativeNumberError;const r=await Utils.findFirstElement(this.helper,e),i=await r.isClickable(),o=await r.isDisplayed();if(!i||!o)throw new errors.GError(errors.GErrorKey.ElementNotEnabledOrDisplayed,e);const a=(await r.getTagName()).toLowerCase(),n=Utils.getElementId(r);let s="option";"ul"===a&&(s="li");const l=this.helper.browser,h=await l.findElementsFromElement(n,"css selector",s);if(0===h.length)throw new errors.EmptySelectControl;if(h.length-1<t)throw new errors.InvalidSelectOptionIndex(t,h.length);if("select"===a)await r.selectByIndex(t);else{if("ul"!==a)throw new errors.InvalidSelectOptionStrategy(a);{const e=Utils.getElementId(h[t]);if(e)return l.elementClick(e)}}}async setState(e,t){var r,i,o,a,n,s;const l=this.helper.browser,h=await Utils.findFirstElement(this.helper,e);if(!await h.isEnabled())throw new errors.GError(errors.GErrorKey.DisabledElementErr,e);const d=Utils.getElementId(h);!1===await h.isDisplayedInViewport()&&await h.scrollIntoView();if(await l.isElementSelected(d)!==t){const e="safari"===(null===(o=null===(i=null===(r=this.helper.browser)||void 0===r?void 0:r.capabilities)||void 0===i?void 0:i.browserName)||void 0===o?void 0:o.toLowerCase()),t=null===(s=null===(n=null===(a=this.helper.browser)||void 0===a?void 0:a.capabilities)||void 0===n?void 0:n.browserVersion)||void 0===s?void 0:s.startsWith("13.0");e&&t?await this.helper.executeScript(e=>{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)},h):await l.elementClick(d)}}async scrollIntoView(e,t){return await Utils.scrollIntoView(this.helper,e,t)}async scrollTo(e,t=0,r=0){await this.helper.scrollTo(e,t,r)}async getElementBounds(e){const t=await this.helper.grabElementBoundingRect(e);return{left:t.x,top:t.y,width:t.width,height:t.height}}async waitForElementProperty(e,t,r,i){const o=await Utils.findFirstElement(this.helper,e);if(!await this.helper.executeScript((e,t,r)=>typeof e[t]!==r.UNDEFINED,o,t,constants_1.TYPE_OF_VAR))throw new errors.InvalidElementPropertyError(e,t);const a=message_1.format(message_1.localize(errors.GErrorKey.TimeOutForElementHasProptery),e,t,r);await this.helper.browser.waitUntil(async()=>await o.getProperty(t)===r,{timeout:1e3*i,timeoutMsg:a,interval:500})}async waitForValueChanged(e,t,r,i){const o=await Utils.findFirstElement(this.helper,e);if(!await this.helper.executeScript((e,t,r)=>typeof e[t]!==r.UNDEFINED,o,t,constants_1.TYPE_OF_VAR))throw new errors.InvalidElementPropertyError(e,t);const a=message_1.format(message_1.localize(errors.GErrorKey.TimeoutForValueChange),e,t),n=await o.getProperty(t);i&&n===i||await this.helper.browser.waitUntil(async()=>await o.getProperty(t)!==n,{timeout:1e3*r,timeoutMsg:a,interval:500})}_instanceOfCoordinate(e){return!(typeof e===constants_1.TYPE_OF_VAR.STRING||!e)&&("x"in e&&"y"in e)}async dragElementToElement(e,t,r){await this.scrollToElement(e);const i=await this.getElementCoordinate(e),o=await this.getElementCoordinate(t);await this.dragAndDropMouse(i,o,r)}async dragElementToCoordinate(e,t,r){await this.scrollToElement(e);const i=await this.getElementCoordinate(e);await this.dragAndDropMouse(i,t,r)}async dragAndDropToElement(e,t,r){const i=await this.getElementCoordinate(t);await this.dragAndDropMouse(e,i,r)}async dragAndDropMouse(e,t,r){var i;const o=null===(i=this.helper)||void 0===i?void 0:i.browser;if(!o)return;const a=Math.floor(t.x-e.x),n=Math.floor(t.y-e.y);o.isW3C?(await o.performActions([{type:"pointer",id:"finger1",parameters:{pointerType:"mouse"},actions:[{type:"pointerMove",duration:0,x:e.x,y:e.y},{type:"pointerDown",button:0},{type:"pause",duration:750},{type:"pointerMove",origin:"pointer",duration:r,x:a,y:n},{type:"pointerUp",button:0}]}]),await o.releaseActions()):(await o.moveToElement(null,Math.floor(e.x),Math.floor(e.y)),await o.buttonDown(0),await this.moveIt(o,e,t,r),await o.buttonUp(0),await o.moveToElement(null,Math.floor(-1*t.x),Math.floor(-1*t.y)))}async moveIt(e,t,r,i){if(!e)return;let o=1500;void 0!==i&&(o=i);const a=Math.floor(o/30),n=(r.x-t.x)/o,s=(r.y-t.y)/o;let l=Math.floor(t.x),h=Math.floor(t.y);for(let r=1;r<=a;r++){const i=Math.floor(t.x+30*n*r),o=Math.floor(t.y+30*s*r);await e.moveToElement(null,i-l,o-h),await e.pause(20),l=i,h=o}await e.moveToElement(null,Math.floor(r.x-l),Math.floor(r.y-h))}async getElementCoordinate(e){var t;const r=null===(t=this.helper)||void 0===t?void 0:t.browser;let i={x:0,y:0};if(!r)return i;const o=await this.helper._locate(e,!1),a=Utils.getElementId(o[0]);if(r.getElementLocationInView){const e=await r.getElementLocationInView(a),t=await r.getElementSize(a);if(!e||!t)return i;i={x:e.x+t.width/2,y:e.y+t.height/2}}else if(r.getElementRect){const e=await r.getElementRect(a);if(!e)return i;i={x:Math.floor(e.x+e.width/2),y:Math.floor(e.y+e.height/2)}}return i}async scrollToElement(e){const t=await Utils.findFirstElement(this.helper,e);t&&await t.scrollIntoView()}}exports.WebDriverWrapper=WebDriverWrapper,exports.default=new WebDriverWrapper;
//# sourceMappingURL=../../../debug/helper/wrapper/webwrapper.js.map
